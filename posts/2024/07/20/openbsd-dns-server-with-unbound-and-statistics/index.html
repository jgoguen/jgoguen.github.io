<!doctype html><html lang=en><head><title>OpenBSD DNS Server with Unbound and Statistics · Heap Overrun
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Joel Goguen"><meta name=description content="Using OpenBSD as a caching recursive DNS resolver with statistics and log
collection."><meta name=keywords content="blog,developer,sysadmin,system administrator,personal,firewall,OpenBSD,Linux"><meta property="og:url" content="https://jgoguen.ca/posts/2024/07/20/openbsd-dns-server-with-unbound-and-statistics/"><meta property="og:site_name" content="Heap Overrun"><meta property="og:title" content="OpenBSD DNS Server with Unbound and Statistics"><meta property="og:description" content="Using OpenBSD as a caching recursive DNS resolver with statistics and log collection."><meta property="og:locale" content="en_ca"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-20T00:00:00+00:00"><meta property="article:modified_time" content="2024-07-21T13:36:26-04:00"><meta property="article:tag" content="OpenBSD"><meta property="article:tag" content="Network"><meta property="article:tag" content="Pf"><meta property="article:tag" content="Unbound"><meta property="article:tag" content="Dns"><meta property="og:image" content="https://jgoguen.ca/img/logo.jpg"><link rel=canonical href=https://jgoguen.ca/posts/2024/07/20/openbsd-dns-server-with-unbound-and-statistics/><link rel=preload href=https://jgoguen.ca/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://jgoguen.ca/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://jgoguen.ca/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://jgoguen.ca/css/coder.min.07092c1350ffd254998dc43a44ae96e617d14af4df4602626878df89189c5e1a.css integrity="sha256-BwksE1D/0lSZjcQ6RK6W5hfRSvTfRgJiaHjfiRicXho=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jgoguen.ca/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jgoguen.ca/sass/style.min.8d285dfdfa8a048f760ab9b8b4fadc3c232efac15641c1b573a9cc17aed43401.css integrity="sha256-jShd/fqKBI92Crm4tPrcPCMu+sFWQcG1c6nMF67UNAE=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=https://jgoguen.ca/images/favicon.svg sizes=any><link rel=icon type=image/png href=https://jgoguen.ca/img/favicon_32x32.png sizes=32x32><link rel=icon type=image/png href=https://jgoguen.ca/img/favicon_16x16.png sizes=16x16><link rel=apple-touch-icon href=https://jgoguen.ca/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://jgoguen.ca/images/apple-touch-icon.png><link rel=manifest href=https://jgoguen.ca/site.webmanifest><link rel=mask-icon href=https://jgoguen.ca/images/safari-pinned-tab.svg color=#5bbad5><link rel=me href=https://hachyderm.io/@jgoguen><meta name=robots content="noai, noimageai"><meta name=CCBot content="nofollow"><meta name=tdm-reservation content="1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"OpenBSD DNS Server with Unbound and Statistics","headline":"OpenBSD DNS Server with Unbound and Statistics","alternativeHeadline":"","description":"Using OpenBSD as a caching recursive DNS resolver with statistics and log collection.","inLanguage":"en-ca","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https://jgoguen.ca/posts/2024/07/20/openbsd-dns-server-with-unbound-and-statistics/"},"author":{"@type":"Person","name":"Joel Goguen","url":"https://jgoguen.ca/about"},"copyrightHolder":"Heap Overrun","copyrightYear":"2024","dateCreated":"2024-07-20T00:00:00.00Z","datePublished":"2024-07-20T00:00:00.00Z","dateModified":"2024-07-21T13:36:26.00Z","publisher":{"@type":"Organization","name":"Heap Overrun","url":"https://jgoguen.ca/","logo":{"@type":"ImageObject","url":"https://jgoguen.ca/img/logo.jpg","width":"32","height":"32"}},"image":"https://jgoguen.ca/img/logo.jpg","url":"https://jgoguen.ca/posts/2024/07/20/openbsd-dns-server-with-unbound-and-statistics/","wordCount":"2013","genre":["OpenBSD","network","pf","unbound","dns"],"keywords":[]}</script></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=scroll-to-top class=hidden><i class="fa fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://jgoguen.ca/>Heap Overrun
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/about>About Me</a></li><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/docs/resume.pdf>Résumé</a></li><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/posts>Posts</a></li><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/contact>Contact Me</a></li></ul></section></nav><div class=content><div id=progress-bar class=hidden aria-hidden=true></div><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://jgoguen.ca/posts/2024/07/20/openbsd-dns-server-with-unbound-and-statistics/>OpenBSD DNS Server with Unbound and Statistics</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-07-20T00:00:00Z>July 20, 2024
</time></span><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-07-21T13:36:26-04:00>Updated: July 21, 2024
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
10-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://jgoguen.ca/tags/openbsd/>OpenBSD</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jgoguen.ca/tags/network/>Network</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jgoguen.ca/tags/pf/>Pf</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jgoguen.ca/tags/unbound/>Unbound</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jgoguen.ca/tags/dns/>Dns</a></span></div></div></header><div><h2 id=dns-servers>DNS Servers
<a class=heading-link href=#dns-servers><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Your network&rsquo;s DNS is delegated to two public Internet resolvers. I&rsquo;ve used
Google Public DNS here purely to illustrate how to configure the DNS servers
used by your LAN, but you could easily use quad9 or Cloudflare or any other
public DNS service. Some people may have various privacy concerns with these
companies, or with any public DNS service, and some people may have more
extensive home networking needs that justify internal DNS servers (like running
a <a href=https://jellyfin.org/ class=external-link target=_blank rel=noopener>Jellyfin media server</a>).</p><p>If this is you, you could run your own caching recursive DNS resolver! You can
do this on the gateway device, but it&rsquo;s best if you can spare at least two other
servers. They don&rsquo;t need to be nearly as powerful as the gateway device, I&rsquo;m
running mine on two Raspberry Pi 4b units with 2GB RAM, and they&rsquo;re doing quite
well.</p><p>Once again, OpenBSD offers a great solution. The
<a href=https://man.openbsd.org/unbound class=external-link target=_blank rel=noopener><code>unbound(8)</code></a> DNS server is provided with
OpenBSD, is fairly simple to configure, and can function as both an internal
name server and a caching recursive resolver for public Internet DNS. I&rsquo;ll also
enable DNSSEC validation.</p><p>Note that you could also use <a href=https://man.openbsd.org/unbound class=external-link target=_blank rel=noopener><code>nsd(8)</code></a> as the
authoritative nameserver for your network. This works well for some people. I&rsquo;ve
chosen not to do this because I want the same DNS names internally and
externally for accessing self-hosted services and that&rsquo;s much easier to do
with only <a href=https://man.openbsd.org/unbound class=external-link target=_blank rel=noopener><code>unbound(8)</code></a>.</p><h3 id=dns-server-preparation>DNS Server Preparation
<a class=heading-link href=#dns-server-preparation><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Every good server begins with a good firewall configuration. A minimal
<a href=https://man.openbsd.org/pf.conf class=external-link target=_blank rel=noopener><code>pf.conf(5)</code></a> suitable for a DNS server:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>if_lan = &#34;bse0&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>set block-policy return
</span></span><span class=line><span class=cl>set skip on lo0
</span></span><span class=line><span class=cl>set reassemble yes no-df
</span></span><span class=line><span class=cl>set loginterface egress
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>match in all scrub (no-df random-id reassemble tcp)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Port build user does not need network
</span></span><span class=line><span class=cl>block drop out log quick proto {tcp udp} user _pbuild
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Control inbound traffic, allow outbound by default
</span></span><span class=line><span class=cl>block return all
</span></span><span class=line><span class=cl>pass out modulate state
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Allow inbound DHCP
</span></span><span class=line><span class=cl>pass in on $if_lan inet proto udp from port bootps to port bootpc
</span></span><span class=line><span class=cl>pass out on $if_lan inet proto udp from port bootpc to port bootps
</span></span><span class=line><span class=cl>pass in on $if_lan inet6 proto udp from fe80::/10 port dhcpv6-server to fe80::/10 port dhcpv6-client no state
</span></span><span class=line><span class=cl>pass out on $if_lan inet6 proto udp from fe80::/10 port dhcpv6-client to fe80::/10 port dhcpv6-server no state
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Allow inbound ICMP
</span></span><span class=line><span class=cl>pass in on $if_lan inet proto icmp to ($if_lan)
</span></span><span class=line><span class=cl>pass in on $if_lan inet6 proto icmp6 to { ($if_lan) ff02::1/16 fe80::/10 }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Allow inbound SSH
</span></span><span class=line><span class=cl>pass in on $if_lan proto tcp from $if_lan:network to ($if_lan) port 22 modulate state
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Allow inbound DNS
</span></span><span class=line><span class=cl>pass in on $if_lan proto { tcp udp } from $if_lan:network to ($if_lan) port 53 modulate state
</span></span><span class=line><span class=cl>pass in on $if_lan inet6 proto { tcp udp } from fe80::/10 to port 53 modulate state
</span></span></code></pre></div><p>Validate and enable the new ruleset:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas pfctl -nf /etc/pf.conf
</span></span><span class=line><span class=cl>% doas pfctl -F rules -f /etc/pf.conf
</span></span></code></pre></div><h3 id=ip-address-setup>IP Address Setup
<a class=heading-link href=#ip-address-setup><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>DNS servers, by their nature, require a static IP address. You can edit the
relevant <a href=https://man.openbsd.org/hostname.if class=external-link target=_blank rel=noopener><code>hostname.if(5)</code></a> file to set a
static IP address for the DNS server, or edit
<a href=https://man.openbsd.org/dhcpd.conf class=external-link target=_blank rel=noopener><code>dhcpd.conf(5)</code></a> to set a <code>fixed-address</code>
for the DNS server&rsquo;s MAC address.</p><p>If you use <a href=https://man.openbsd.org/hostname.if class=external-link target=_blank rel=noopener><code>hostname.if(5)</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% cat /etc/hostname.bse0
</span></span><span class=line><span class=cl>inet 10.0.0.5 255.255.255.0 10.0.0.255
</span></span><span class=line><span class=cl>inet6 fd01:2345:6789:abcd::5 <span class=m>64</span>
</span></span><span class=line><span class=cl>up
</span></span></code></pre></div><p>If you use DHCP, add these lines (one block per DNS server) to the <code>subnet</code>
block in <a href=https://man.openbsd.org/dhcpd.conf class=external-link target=_blank rel=noopener><code>dhcpd.conf(5)</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>host dns1 {
</span></span><span class=line><span class=cl>  hardware ethernet 12:34:56:78:9a:bc;
</span></span><span class=line><span class=cl>  fixed-address 10.0.0.0.5;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Validate and restart <a href=https://man.openbsd.org/dhcpd class=external-link target=_blank rel=noopener><code>dhcpd(8)</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas dhcpd -n <span class=o>&amp;&amp;</span> doas rcctl restart dhcpd
</span></span></code></pre></div><p>You will still need to set a static IPv6 address in the relevant
<a href=https://man.openbsd.org/hostname.if class=external-link target=_blank rel=noopener><code>hostname.if(5)</code></a> file if you plan to
advertise the DNS servers over IPv6. Make sure your DNS servers are accessible
at their static addresses before proceeding!</p><h3 id=unbound8-configuration><code>unbound(8)</code> Configuration
<a class=heading-link href=#unbound8-configuration><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Set up <a href=https://man.openbsd.org/unbound.conf class=external-link target=_blank rel=noopener><code>unbound.conf(5)</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% cat /var/unbound/etc/unbound.conf
</span></span><span class=line><span class=cl>server:
</span></span><span class=line><span class=cl>  <span class=c1># Default is to deny queries. Use `access-control` to allow clients (defined</span>
</span></span><span class=line><span class=cl>  <span class=c1># by CIDR or specific address) to send DNS queries.</span>
</span></span><span class=line><span class=cl>  access-control: 192.168.0.0/16 allow
</span></span><span class=line><span class=cl>  access-control: 172.16.0.0/12 allow
</span></span><span class=line><span class=cl>  access-control: 10.0.0.0/8 allow
</span></span><span class=line><span class=cl>  access-control: fe80::/10 allow
</span></span><span class=line><span class=cl>  access-control: fc00::/7 allow
</span></span><span class=line><span class=cl>  access-control: 127.0.0.0/8 allow
</span></span><span class=line><span class=cl>  access-control: ::1/128 allow
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Some extra privacy</span>
</span></span><span class=line><span class=cl>  hide-identity: yes
</span></span><span class=line><span class=cl>  hide-version: yes
</span></span><span class=line><span class=cl>  qname-minimisation: yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Listen on all interfaces/addresses</span>
</span></span><span class=line><span class=cl>  interface: 0.0.0.0
</span></span><span class=line><span class=cl>  interface: ::
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Allow replies for LAN zones to contain RFC1918 addresses.</span>
</span></span><span class=line><span class=cl>  insecure-lan-zones: yes
</span></span><span class=line><span class=cl>  private-address: 10.0.0.0/8
</span></span><span class=line><span class=cl>  private-address: 172.16.0.0/12
</span></span><span class=line><span class=cl>  private-address: 192.168.0.0/16
</span></span><span class=line><span class=cl>  private-domain: example.lan
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Threads should be no more than the number of available CPU cores</span>
</span></span><span class=line><span class=cl>  num-threads: <span class=m>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Configure the DNS cache, to speed up requests for frequently requested</span>
</span></span><span class=line><span class=cl>  <span class=c1># domains. Cache slabs should be no more than the number of threads.</span>
</span></span><span class=line><span class=cl>  <span class=c1># rrset-cache-size should be about double msg-cache-size.</span>
</span></span><span class=line><span class=cl>  cache-max-ttl: <span class=m>604800</span>
</span></span><span class=line><span class=cl>  cache-min-ttl: <span class=m>1800</span>
</span></span><span class=line><span class=cl>  infra-cache-numhosts: <span class=m>100000</span>
</span></span><span class=line><span class=cl>  infra-cache-slabs: <span class=m>4</span>
</span></span><span class=line><span class=cl>  key-cache-slabs: <span class=m>4</span>
</span></span><span class=line><span class=cl>  msg-cache-size: 128m
</span></span><span class=line><span class=cl>  msg-cache-slabs: <span class=m>4</span>
</span></span><span class=line><span class=cl>  rrset-cache-size: 256m
</span></span><span class=line><span class=cl>  rrset-cache-slabs: <span class=m>4</span>
</span></span><span class=line><span class=cl>  <span class=c1># Attempt to prefetch oft-requested names before their cache entry expires</span>
</span></span><span class=line><span class=cl>  prefetch: yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Configure port and socket options</span>
</span></span><span class=line><span class=cl>  outgoing-range: <span class=m>200</span>
</span></span><span class=line><span class=cl>  so-reuseport: yes
</span></span><span class=line><span class=cl>  so-rcvbuf: 2m
</span></span><span class=line><span class=cl>  so-sndbuf: 2m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  use-syslog: yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow using unbound-control(8)</span>
</span></span><span class=line><span class=cl>remote-control:
</span></span><span class=line><span class=cl>  control-enable: yes
</span></span><span class=line><span class=cl>  control-interface: /var/run/unbound.sock
</span></span></code></pre></div><p>If you want to have DNS resolution for LAN servers, it is easiest to add them to
a separate file and include it. Add this line to the <code>server</code> section:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>include</span><span class=p>:</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>unbound</span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>lan</span><span class=o>-</span><span class=n>hosts</span><span class=o>.</span><span class=n>conf</span>
</span></span></code></pre></div><p>Add LAN client info:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>cat</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>unbound</span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>lan</span><span class=o>-</span><span class=n>hosts</span><span class=o>.</span><span class=n>conf</span>
</span></span><span class=line><span class=cl><span class=c1># Change &#39;static&#39; to &#39;typetransparent&#39; if you want to use the same DNS names</span>
</span></span><span class=line><span class=cl><span class=c1># internally and externally, but not all DNS names will be given here.</span>
</span></span><span class=line><span class=cl><span class=n>local</span><span class=o>-</span><span class=n>zone</span><span class=p>:</span> <span class=s2>&#34;example.lan.&#34;</span> <span class=k>static</span>
</span></span><span class=line><span class=cl><span class=n>local</span><span class=o>-</span><span class=n>data</span><span class=p>:</span> <span class=s2>&#34;gateway.example.lan IN A 10.0.0.1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>local</span><span class=o>-</span><span class=n>data</span><span class=p>:</span> <span class=s2>&#34;dns1.example.lan. IN A 10.0.0.5&#34;</span>
</span></span><span class=line><span class=cl><span class=n>local</span><span class=o>-</span><span class=n>data</span><span class=p>:</span> <span class=s2>&#34;dns2.example.lan. IN A 10.0.0.6&#34;</span>
</span></span></code></pre></div><p>Validate, enable, and start <a href=https://man.openbsd.org/unbound class=external-link target=_blank rel=noopener><code>unbound(8)</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas unbound-checkconf
</span></span><span class=line><span class=cl>% doas rcctl <span class=nb>enable</span> unbound
</span></span><span class=line><span class=cl>% doas rcctl start unbound
</span></span></code></pre></div><p>You should be able to query a public DNS name and get a response:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% dig www.google.com @::1
</span></span></code></pre></div><h3 id=make-the-rest-of-the-lan-use-it>Make the rest of the LAN use it
<a class=heading-link href=#make-the-rest-of-the-lan-use-it><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>To make LAN clients use your new DNS servers, edit
<a href=https://man.openbsd.org/dhcpd.conf class=external-link target=_blank rel=noopener><code>dhcpd.conf(5)</code></a> and change the
<code>domain-name-servers</code> option to the IP addresses of your DNS servers. Restart
<a href=https://man.openbsd.org/dhcpd class=external-link target=_blank rel=noopener><code>dhcpd(8)</code></a> after validating its configuration
file, keeping in mind that it could take up to the length of the existing DHCP
lease for clients to pick up the new DNS servers:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas dhcpd -n <span class=o>&amp;&amp;</span> doas rcctl restart dhcpd
</span></span></code></pre></div><p>If you&rsquo;re going to advertise the DNS servers over IPv6, also edit
<a href=https://man.openbsd.org/rad.conf class=external-link target=_blank rel=noopener><code>rad.conf(5)</code></a> to add a <code>dns</code> block:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>dns {
</span></span><span class=line><span class=cl>  nameserver {
</span></span><span class=line><span class=cl>    fd01:2345:6789:abcd::5
</span></span><span class=line><span class=cl>    fd01:2345:6789:abcd::6
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Validate and restart <a href=https://man.openbsd.org/rad class=external-link target=_blank rel=noopener><code>rad(8)</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas rad -n <span class=o>&amp;&amp;</span> doas rcctl restart rad
</span></span></code></pre></div><h2 id=add-monitoring>Add Monitoring
<a class=heading-link href=#add-monitoring><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>This is another point where you may be satisfied with what you have set up
already. If so, you can safely stop reading here, or carry on to see if you want
to continue. For this next section, we&rsquo;ll add monitoring of the DNS service.</p><h3 id=pre-requisites-monitoring-software>Pre-requisites: Monitoring software
<a class=heading-link href=#pre-requisites-monitoring-software><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>This section assumes you have <a href=https://grafana.com/ class=external-link target=_blank rel=noopener>Grafana</a>,
<a href=https://www.influxdata.com/ class=external-link target=_blank rel=noopener>InfluxxDB 2</a>, and
<a href=https://www.influxdata.com/time-series-platform/telegraf/ class=external-link target=_blank rel=noopener>Telegraf</a> already
installed and working. A few configuration details you&rsquo;ll want to include
(or have equivalents set up):</p><p>For InfluxDB, make sure you already have an organization, bucket, and a token
with write access to the bucket.</p><p>For Telegraf, a minimal <code>telegraf.conf</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[[inputs.socket_listener]]
</span></span><span class=line><span class=cl>    service_address = &#34;udp://:9456&#34;
</span></span><span class=line><span class=cl>    data_format = &#34;collectd&#34;
</span></span><span class=line><span class=cl>    collectd_auth_file = &#34;/etc/telegraf/collectd_auth&#34;
</span></span><span class=line><span class=cl>    collectd_security_level = &#34;encrypt&#34;
</span></span><span class=line><span class=cl>    collectd_typesdb = [&#34;/usr/share/collectd/types.db&#34;]
</span></span><span class=line><span class=cl>    collectd_parse_multivalue = &#34;split&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[[outputs.influxdb_v2]]
</span></span><span class=line><span class=cl>    urls = [&#34;https://influxdb:8086&#34;]
</span></span><span class=line><span class=cl>    token = &#34;@{secrets:influxdb_dns_bucket_token}&#34;
</span></span><span class=line><span class=cl>    organization = &#34;myorg&#34;
</span></span><span class=line><span class=cl>    bucket = &#34;dns&#34;
</span></span></code></pre></div><h3 id=unboundconf5-changes><code>unbound.conf(5)</code> changes
<a class=heading-link href=#unboundconf5-changes><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Add these configuration items to the <code>server</code> block in your existing
<a href=https://man.openbsd.org/unbound.conf class=external-link target=_blank rel=noopener><code>unbound.conf(5)</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>extended-statistics: yes
</span></span><span class=line><span class=cl>log-local-actions: yes
</span></span><span class=line><span class=cl>log-queries: no
</span></span><span class=line><span class=cl>log-replies: yes
</span></span><span class=line><span class=cl>statistics-cumulative: yes
</span></span><span class=line><span class=cl>val-log-level: 2
</span></span></code></pre></div><p>Validate and restart <a href=https://man.openbsd.org/unbound class=external-link target=_blank rel=noopener><code>unbound(8)</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas unbound-checkconf <span class=o>&amp;&amp;</span> doas rcctl restart unbound
</span></span></code></pre></div><h3 id=dns-statistics>DNS Statistics
<a class=heading-link href=#dns-statistics><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p><a href=https://man.openbsd.org/unbound class=external-link target=_blank rel=noopener><code>unbound(8)</code></a> is now recording statistics,
which you can view at any time:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas unbound-control stats_noreset
</span></span></code></pre></div><p>To be useful, we need to get those statistics to InfluxDB. To do so, we&rsquo;ll use
<code>collectd</code>. Install it first:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas pkg_add collectd
</span></span></code></pre></div><p>A minimal <code>collectd.conf</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Hostname    &#34;dns2&#34;
</span></span><span class=line><span class=cl>LoadPlugin syslog
</span></span><span class=line><span class=cl>&lt;Plugin syslog&gt;
</span></span><span class=line><span class=cl>  LogLevel info
</span></span><span class=line><span class=cl>&lt;/Plugin&gt;
</span></span><span class=line><span class=cl>LoadPlugin exec
</span></span><span class=line><span class=cl>LoadPlugin network
</span></span><span class=line><span class=cl>&lt;Plugin exec&gt;
</span></span><span class=line><span class=cl>  Exec _collectd &#34;/usr/local/bin/collectd-unbound&#34;
</span></span><span class=line><span class=cl>&lt;/Plugin&gt;
</span></span><span class=line><span class=cl>&lt;Plugin network&gt;
</span></span><span class=line><span class=cl>  Server &#34;10.0.0.4&#34; &#34;9456&#34;
</span></span><span class=line><span class=cl>&lt;/Plugin&gt;
</span></span></code></pre></div><p>To allow <code>collectd</code> to run <code>unbound-control</code> to get statistics, add this line to
<a href=https://man.openbsd.org/doas.conf class=external-link target=_blank rel=noopener><code>doas.conf(5)</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>permit nopass _collectd as _unbound cmd unbound-control args stats_noreset
</span></span></code></pre></div><p>Finally, copy this script to <code>/usr/local/bin/collectd-unbound</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;/bin:/sbin:/usr/bin:/usr/sbin&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>HOSTNAME</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>COLLECTD_HOSTNAME</span><span class=k>:-$(</span>hostname -s<span class=k>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>INTERVAL</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>COLLECTD_INTERVAL</span><span class=k>:-</span><span class=nv>30</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> sleep <span class=s2>&#34;</span><span class=nv>$INTERVAL</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  doas -u _unbound unbound-control stats_noreset <span class=p>|</span> egrep -v <span class=s2>&#34;^(histogram\.|time\.now|time\.elapsed)&#34;</span> <span class=p>|</span> sed -re <span class=s2>&#34;s;^([^=]+)=([0-9\.]+);PUTVAL </span><span class=nv>$HOSTNAME</span><span class=s2>/exec-unbound/gauge-\1 interval=</span><span class=nv>$INTERVAL</span><span class=s2> N:\2;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  awk -v <span class=nv>h</span><span class=o>=</span><span class=nv>$HOSTNAME</span> -v <span class=nv>i</span><span class=o>=</span><span class=nv>$INTERVAL</span> <span class=s1>&#39;END { print &#34;PUTVAL &#34; h &#34;/exec-unbound/gauge-num.adhosts interval=&#34; i &#34; N:&#34; FNR }&#39;</span> /var/unbound/etc/unbound-adhosts.conf
</span></span><span class=line><span class=cl>  awk -v <span class=nv>h</span><span class=o>=</span><span class=nv>$HOSTNAME</span> -v <span class=nv>i</span><span class=o>=</span><span class=nv>$INTERVAL</span> <span class=s1>&#39;!/^($|[:space:]*#)/ { hosts++ } END { print &#34;PUTVAL &#34; h &#34;/exec-unbound/gauge-num.allowlist interval=&#34; i &#34; N:&#34; hosts+0 }&#39;</span> /var/unbound/allowlist.txt
</span></span><span class=line><span class=cl>  awk -v <span class=nv>h</span><span class=o>=</span><span class=nv>$HOSTNAME</span> -v <span class=nv>i</span><span class=o>=</span><span class=nv>$INTERVAL</span> <span class=s1>&#39;!/^($|[:space:]*#)/ { hosts++ } END { print &#34;PUTVAL &#34; h &#34;/exec-unbound/gauge-num.manual-blocks interval=&#34; i &#34; N:&#34; hosts+0 }&#39;</span> /var/unbound/blocklist.txt
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>0</span>
</span></span></code></pre></div><p>Make sure the script is owned by <code>root:_collectd</code> and give it permissions
<code>0750</code>.</p><p>Enable and start <code>collectd</code>, it will shortly start sending statistics to
InfluxDB:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas rcctl <span class=nb>enable</span> collectd
</span></span><span class=line><span class=cl>% doas rcctl start collectd
</span></span></code></pre></div><p>DNS queries are being logged to <a href=https://man.openbsd.org/syslogd class=external-link target=_blank rel=noopener><code>syslogd(8)</code></a>.
We need to send them to an external program for processing and forwarding to
InfluxDB. I wrote a simple Go program to read, queue, process, and send the
logs. Download <a href=https://jgoguen.ca/static/go/unbound2influx.go>unbound2influx.go</a> and build it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% go build -o unbound2influx unbound2influx.go
</span></span></code></pre></div><p>Set permissions and move it into place:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas chown root:_syslogd unbound2influx
</span></span><span class=line><span class=cl>% doas chmod <span class=m>0750</span> unbound2influx
</span></span><span class=line><span class=cl>% doas mv unbound2influx /usr/local/bin/unbound2influx
</span></span></code></pre></div><p>You also need to create <code>/etc/unbound2influx.cfg</code> and fill in details. <code>hosts</code>
points to the file you use to define LAN addresses, if you haven&rsquo;t done that
give it a path to an empty file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas cat /etc/unbound2influx.cfg
</span></span><span class=line><span class=cl><span class=nv>token</span> <span class=o>=</span> &lt;API token from InfluxDB&gt;
</span></span><span class=line><span class=cl><span class=nv>bucket</span> <span class=o>=</span> &lt;bucket name from InfluxDB&gt;
</span></span><span class=line><span class=cl><span class=nv>org</span> <span class=o>=</span> &lt;org name from InfluxDB&gt;
</span></span><span class=line><span class=cl><span class=nv>hosts</span> <span class=o>=</span> /var/unbound/etc/lan-hosts.conf
</span></span><span class=line><span class=cl><span class=nv>influx_host</span> <span class=o>=</span> http://10.0.0.4:8086
</span></span></code></pre></div><p>Edit <a href=https://man.openbsd.org/syslog.conf class=external-link target=_blank rel=noopener><code>syslog.conf(5)</code></a> to add these lines
to the bottom of the file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>!unbound
</span></span><span class=line><span class=cl>*.* |/usr/local/bin/unbound2influx
</span></span></code></pre></div><p>Restart <a href=https://man.openbsd.org/syslogd class=external-link target=_blank rel=noopener><code>syslogd(8)</code></a> and logs will start
streaming to InfluxDB as DNS requests are made:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas rcctl restart syslogd
</span></span></code></pre></div><h3 id=ad-blocking>Ad Blocking
<a class=heading-link href=#ad-blocking><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>The way the Internet is today, ad blocking is practically a fundamental security
requirement. Many third-party ad services (and some first-party ad services) are
regularly used to serve malicious ads or malicious content along with legitimate
ads. There&rsquo;s also a lot to be concerned about regarding privacy online the way
ad networks operate. You can&rsquo;t stop all ads everywhere, but let&rsquo;s set up
<a href=https://man.openbsd.org/unbound class=external-link target=_blank rel=noopener><code>unbound(8)</code></a> to block what we can while
you&rsquo;re at home.</p><p>Start by creating two empty files, <code>allowlist.txt</code> and <code>blocklist.txt</code>. They can
be anywhere, but the script I wrote defaults to <code>allowlist.txt</code> and
<code>blocklist.txt</code> in the same directory as the script. The script, which I&rsquo;ve
installed at <code>/var/unbound/unbound-adhosts.py</code> can be
<a href=https://jgoguen.ca/py/unbound-adhosts.py>downloaded here</a>. Set permissions on the files:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas chown root:_unbound unbound-adhosts.py allowlist.txt blocklist.txt
</span></span><span class=line><span class=cl>% doas chmod <span class=m>0755</span> unbound-adhosts.py
</span></span></code></pre></div><p>You can run it now to verify everything works. By default the script will write
out the domain list at <code>/var/unbound/unbound-adhosts.conf</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas /var/unbound/unbound-adhosts.py -v
</span></span></code></pre></div><p>Add a line to the end of the <code>server</code> section in
<a href=https://man.openbsd.org/unbound class=external-link target=_blank rel=noopener><code>unbound(8)</code></a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>include</span><span class=p>:</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>unbound</span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>unbound</span><span class=o>-</span><span class=n>adhosts</span><span class=o>.</span><span class=n>conf</span>
</span></span></code></pre></div><p>You can validate and restart <a href=https://man.openbsd.org/unbound class=external-link target=_blank rel=noopener><code>unbound(8)</code></a> to
verify everything works so far:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas unbound-control reload_keep_cache
</span></span><span class=line><span class=cl>% host ad-feeds.com ::1
</span></span><span class=line><span class=cl>Using domain server:
</span></span><span class=line><span class=cl>Name: ::1
</span></span><span class=line><span class=cl>Address: ::1#53
</span></span><span class=line><span class=cl>Aliases:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host ad-feeds.com not found: 3<span class=o>(</span>NXDOMAIN<span class=o>)</span>
</span></span></code></pre></div><p>Finally, add an entry to <code>root</code>&rsquo;s crontab to run this periodically:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% doas crontab -e
</span></span></code></pre></div><p>Add this line:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=mi>11</span><span class=o>~</span><span class=mi>20</span>	<span class=o>*/</span><span class=mi>6</span>	<span class=o>*</span>	<span class=o>*</span>	<span class=o>*</span>	<span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>unbound</span><span class=o>/</span><span class=n>unbound</span><span class=o>-</span><span class=n>adhosts</span><span class=o>.</span><span class=n>py</span>
</span></span></code></pre></div><p>Every 6 hours, somewhere between minutes 11-20, your adblock list will be
updated and <a href=https://man.openbsd.org/unbound class=external-link target=_blank rel=noopener><code>unbound(8)</code></a> reloaded.</p><h3 id=pretty-graphs>Pretty Graphs
<a class=heading-link href=#pretty-graphs><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Now that you have DNS data going to InfluxDB, it&rsquo;s time to do something useful
with it. You can <a href=https://jgoguen.ca/grafana/unbound-dashboard.json>download the JSON</a> for
a Grafana dashboard, or use the screenshots below for reference.</p><p><figure class=inline><a href=https://jgoguen.ca/img/grafana/unbound-grafana-1.png target=_blank><img src=https://jgoguen.ca/img/grafana/unbound-grafana-1.png alt="Grafana dashboard showing information about queries, response time, and cache status" width=33%></a></figure><figure class=inline><a href=https://jgoguen.ca/img/grafana/unbound-grafana-2.png target=_blank><img src=https://jgoguen.ca/img/grafana/unbound-grafana-2.png alt="Grafana dashboard showing details about top queried and blocked domains and query types" width=33%></a></figure><figure class=inline><a href=https://jgoguen.ca/img/grafana/unbound-grafana-3.png target=_blank><img src=https://jgoguen.ca/img/grafana/unbound-grafana-3.png alt="Grafana dashboard showing a log of recent queries and top clients by query count" width=33%></a></figure></p><h2 id=whats-next>What&rsquo;s Next?
<a class=heading-link href=#whats-next><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>At this point, take a look at
<a href=https://awesome-selfhosted.net/ class=external-link target=_blank rel=noopener>Awesome Self-hosted</a> and see if there&rsquo;s any
services you want to host on your LAN. You have internal DNS to reach them by
local IP, and your
<a href=https://jgoguen.ca/posts/2024/07/16/openbsd-ipv6-home-internet-gateway-with-att-fibre/>OpenBSD gateway</a>
allows you to easily forward traffic to an internal web server (or you can run
<a href=https://man.openbsd.org/relayd class=external-link target=_blank rel=noopener><code>relayd(8)</code></a> to forward to different places
based on different criteria). Just be careful about what you host and how you
configure the servers and services, your OpenBSD firewall can protect you from
a lot but it can&rsquo;t protect you from a misconfiguration.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2013 -
2024
Joel Goguen
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=https://jgoguen.ca/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script src=https://jgoguen.ca/js/scrollbar.min.1eea81363c83b9d090626bcfd7b529574d2f1b23ddd40a5c76aea3dfd8810712.js integrity="sha256-HuqBNjyDudCQYmvP17UpV00vGyPd1Apcdq6j39iBBxI="></script></body></html>