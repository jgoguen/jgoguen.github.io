<!doctype html><html lang=en><head><title>OpenBSD IPv6 Home Internet Gateway with AT&amp;T Fibre · Heap Overrun
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Joel Goguen"><meta name=description content="Using OpenBSD as a home Internet gateway with AT&amp;T Fibre with IPv6
support
"><meta name=keywords content="blog,developer,sysadmin,system administrator,personal,firewall,OpenBSD,Linux"><meta property="og:url" content="https://jgoguen.ca/posts/2024/07/20/openbsd-ipv6-home-internet-gateway-with-att-fibre/"><meta property="og:site_name" content="Heap Overrun"><meta property="og:title" content="OpenBSD IPv6 Home Internet Gateway with AT&T Fibre"><meta property="og:description" content="Using OpenBSD as a home Internet gateway with AT&amp;T Fibre with IPv6 support"><meta property="og:locale" content="en_ca"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-20T00:00:00+00:00"><meta property="article:modified_time" content="2025-03-07T10:40:22-05:00"><meta property="article:tag" content="OpenBSD"><meta property="article:tag" content="AT&T"><meta property="article:tag" content="Network"><meta property="article:tag" content="Pf"><meta property="article:tag" content="IPv6"><meta property="og:image" content="https://jgoguen.ca/img/logo.jpg"><link rel=canonical href=https://jgoguen.ca/posts/2024/07/20/openbsd-ipv6-home-internet-gateway-with-att-fibre/><link rel=preload href=https://jgoguen.ca/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://jgoguen.ca/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://jgoguen.ca/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://jgoguen.ca/css/coder.min.aa5ef26fa979d6793724ae2dbd71efa94fd16cb1c5c7db3b6651f21f9892a5fd.css integrity="sha256-ql7yb6l51nk3JK4tvXHvqU/RbLHFx9s7ZlHyH5iSpf0=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jgoguen.ca/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jgoguen.ca/css/style.min.51bc8d573bf8d868a603afccfde7fff4e5ca71d65cbc8ee77d8a514fcc208eba.css integrity="sha256-UbyNVzv42GimA6/M/ef/9OXKcdZcvI7nfYpRT8wgjro=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=https://jgoguen.ca/images/favicon.svg sizes=any><link rel=icon type=image/png href=https://jgoguen.ca/img/favicon_32x32.png sizes=32x32><link rel=icon type=image/png href=https://jgoguen.ca/img/favicon_16x16.png sizes=16x16><link rel=apple-touch-icon href=https://jgoguen.ca/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://jgoguen.ca/images/apple-touch-icon.png><link rel=manifest href=https://jgoguen.ca/site.webmanifest><link rel=mask-icon href=https://jgoguen.ca/images/safari-pinned-tab.svg color=#5bbad5><link rel=me href=https://hachyderm.io/@jgoguen><meta name=robots content="noai, noimageai"><meta name=CCBot content="nofollow"><meta name=tdm-reservation content="1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"OpenBSD IPv6 Home Internet Gateway with AT\u0026T Fibre","headline":"OpenBSD IPv6 Home Internet Gateway with AT\u0026T Fibre","alternativeHeadline":"","description":"Using OpenBSD as a home Internet gateway with AT\u0026T Fibre with IPv6 support","inLanguage":"en-ca","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https://jgoguen.ca/posts/2024/07/20/openbsd-ipv6-home-internet-gateway-with-att-fibre/"},"author":{"@type":"Person","name":"Joel Goguen","url":"https://jgoguen.ca/about"},"copyrightHolder":"Heap Overrun","copyrightYear":"2024","dateCreated":"2024-07-20T00:00:00.00Z","datePublished":"2024-07-20T00:00:00.00Z","dateModified":"2025-03-07T10:40:22.00Z","publisher":{"@type":"Organization","name":"Heap Overrun","url":"https://jgoguen.ca/","logo":{"@type":"ImageObject","url":"https://jgoguen.ca/img/logo.jpg","width":"32","height":"32"}},"image":"https://jgoguen.ca/img/logo.jpg","url":"https://jgoguen.ca/posts/2024/07/20/openbsd-ipv6-home-internet-gateway-with-att-fibre/","wordCount":"3960","genre":["OpenBSD","AT\u0026T","network","pf","IPv6"],"keywords":[]}</script></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=scroll-to-top class=hidden><i class="fa fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://jgoguen.ca/>Heap Overrun
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/about>About Me</a></li><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/docs/resume.pdf>Résumé</a></li><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/posts>Posts</a></li><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/contact>Contact Me</a></li></ul></section></nav><div class=content><div id=progress-bar class=hidden aria-hidden=true></div><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://jgoguen.ca/posts/2024/07/20/openbsd-ipv6-home-internet-gateway-with-att-fibre/>OpenBSD IPv6 Home Internet Gateway with AT&amp;T Fibre</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-07-20T00:00:00Z>July 20, 2024
</time></span><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2025-03-07T10:40:22-05:00>Updated: March 7, 2025
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
19-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://jgoguen.ca/tags/openbsd/>OpenBSD</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jgoguen.ca/tags/att/>AT&amp;T</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jgoguen.ca/tags/network/>Network</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jgoguen.ca/tags/pf/>Pf</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jgoguen.ca/tags/ipv6/>IPv6</a></span></div></div></header><div><p>When you sign up for Internet service, one thing you&rsquo;re going to get is a home
gateway. It&rsquo;s going to offer wired and wireless Internet connections plus
a bunch of other things you may not want and probably won&rsquo;t need. Unfortunately,
one of the things it&rsquo;s going to offer you is poor performance. The wireless
network on it may not cover your whole house, and if you&rsquo;re also limited in
where you can hook it up that could mean poor coverage in the most important
areas. It&rsquo;s also not built on the best hardware for the job, so when it counts
the most you may not get the connection speeds you expect. Depending on your
needs, you may find that the ISP hardware doesn&rsquo;t offer you enough flexibility.
And, perhaps most importantly, it&rsquo;s not all that secure, and the firewalls can
be difficult to configure properly.</p><h2 id=before-you-start>Before you start
<a class=heading-link href=#before-you-start><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Before doing anything, decide:</p><ul><li>Are you comfortable installing and configuring a computer (or more) that will
become a critical part of your home Internet setup?</li><li>Are you comfortable being technical support if something isn&rsquo;t working
properly?</li><li>Your ISP is unlikely to give you much support, can you troubleshoot enough to
prove a problem isn&rsquo;t on your end?</li></ul><h2 id=hardware>Hardware
<a class=heading-link href=#hardware><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Most ISP home gateways have a way to put them into bridge mode, where a single
device is directly exposed to the Internet. The AT&amp;T Fibre
standard gateway, the BGW320, does not have a bridge mode. The closest it has is
&ldquo;Passthrough&rdquo;, which works well enough for this.</p><p>For the gateway/router, I&rsquo;m using a
<a href=https://protectli.com/vault-2-port/ class=external-link target=_blank rel=noopener>2-port Protectli vault</a> with 4GB RAM.
It&rsquo;s a good platform, quiet and fanless, fully supported by OpenBSD out of the
box. Throughout this article I&rsquo;ll assume you&rsquo;re also using a Protectli device;
substitute your own device where Protectli is mentioned, and be aware that
interface names may be different.</p><p>You&rsquo;ll most likely want a switch, and some wireless access points. These can be
anything you want; I&rsquo;m using a
<a href=https://store.ui.com/us/en/collections/unifi-switching-utility-poe/products/usw-lite-16-poe class=external-link target=_blank rel=noopener>UniFi 16-port POE+ switch</a>
with a few
<a href=https://store.ui.com/us/en/collections/unifi-wifi-flagship-compact/products/u6-lite class=external-link target=_blank rel=noopener>UniFi AP-6-Lite access points</a>.
If you also want to use UniFi equipment, look through
<a href=https://store.ui.com/us/en/collections/unifi-switching-utility-poe class=external-link target=_blank rel=noopener>https://store.ui.com/us/en/collections/unifi-switching-utility-poe</a> and
<a href=https://store.ui.com/us/en/collections/unifi-wifi-flagship-compact class=external-link target=_blank rel=noopener>https://store.ui.com/us/en/collections/unifi-wifi-flagship-compact</a> to see
what fits your needs.</p><h2 id=installation>Installation
<a class=heading-link href=#installation><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>To begin, install the latest OpenBSD release. I&rsquo;m using OpenBSD 7.5 for this
article. OpenBSD has an
<a href=https://www.openbsd.org/faq/faq4.html class=external-link target=_blank rel=noopener>excellent installation guide</a> you can
follow if needed. The default automatic partition scheme is fine unless you have
some specific needs.</p><p>After installation is complete, reboot and configure
<a href=https://man.openbsd.org/doas class=external-link target=_blank rel=noopener><code>doas(1)</code></a>. Remember that, unlike <code>sudo</code>, all
users who may call <a href=https://man.openbsd.org/doas class=external-link target=_blank rel=noopener><code>doas(1)</code></a> need to pass a
rule in <a href=https://man.openbsd.org/doas.conf class=external-link target=_blank rel=noopener><code>doas.conf(5)</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># cat /etc/doas.conf
</span></span><span style=display:flex><span>permit persist :wheel
</span></span><span style=display:flex><span>permit nopass root
</span></span></code></pre></div><p>Make sure your user is added to the <code>wheel</code> group, or replace <code>:wheel</code> with your
username.</p><h2 id=configuration>Configuration
<a class=heading-link href=#configuration><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><h3 id=wan-mac-address>WAN MAC Address
<a class=heading-link href=#wan-mac-address><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>You will need the MAC address of the Protectli&rsquo;s WAN interface later on. The
BGW320 Passthrough mode will need it. Get that now and write it down for later:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% ifconfig em0 | grep lladdr | awk <span style=color:#a6e3a1>&#39;{ print $2 }&#39;</span>
</span></span><span style=display:flex><span>01:23:45:67:89:ab
</span></span></code></pre></div><h3 id=pf5>pf(5)
<a class=heading-link href=#pf5><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Before configuring anything else, set up
<a href=https://man.openbsd.org/pf.conf class=external-link target=_blank rel=noopener><code>pf.conf(5)</code></a>. <code>egress</code> will be the WAN
interface. This is technically a &ldquo;minimal&rdquo; configuration; ICMPv6 is such
a complicated beast it needs a lot of different rules. The comments I&rsquo;ve added
also make this a lot longer than it really is.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#89dceb;font-weight:700>%</span> doas cat <span style=color:#89dceb;font-weight:700>/</span>etc<span style=color:#89dceb;font-weight:700>/</span>pf<span style=color:#89dceb;font-weight:700>.</span>conf
</span></span><span style=display:flex><span>if_lan <span style=color:#89dceb;font-weight:700>=</span> em1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># List of martians created from all tables in RFC 6890 sections 2.2.2 and 2.2.3</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># where the &#34;Global&#34; flag is FALSE. IPv4 bogons have also been mapped into the</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># 6to4 and Teredo address spaces.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Note that 192.0.0.0/24 and 2001::/23 may be given more specific assignments</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># that are allowed in the future. As of October 2024, no more specific</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># assignments with &#34;Global&#34; set to TRUE are defined.</span>
</span></span><span style=display:flex><span>table <span style=color:#89dceb;font-weight:700>&lt;</span>martians<span style=color:#89dceb;font-weight:700>&gt;</span> <span style=color:#cba6f7>const</span> { \
</span></span><span style=display:flex><span> <span style=color:#6c7086;font-style:italic># IPv4 bogons</span>
</span></span><span style=display:flex><span> <span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>8</span> <span style=color:#fab387>10.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>8</span> <span style=color:#fab387>100.64</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> <span style=color:#fab387>127.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>8</span> <span style=color:#fab387>169.254</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>16</span> \
</span></span><span style=display:flex><span> <span style=color:#fab387>172.16</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>12</span> <span style=color:#fab387>192.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> <span style=color:#fab387>192.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>2.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> <span style=color:#fab387>192.168</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>16</span> <span style=color:#fab387>198.18</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>15</span> \
</span></span><span style=display:flex><span> <span style=color:#fab387>198.51</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>100.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> <span style=color:#fab387>203.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>113.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> <span style=color:#fab387>224.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>4</span> <span style=color:#fab387>240.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>4</span> \
</span></span><span style=display:flex><span> <span style=color:#6c7086;font-style:italic># IPv6 bogons</span>
</span></span><span style=display:flex><span> ::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>128</span> ::<span style=color:#fab387>1</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>128</span> ::ffff:<span style=color:#fab387>0</span>:<span style=color:#fab387>0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>96</span> <span style=color:#fab387>100</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>64</span> <span style=color:#fab387>2001</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>23</span> fc00::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>7</span> fe80::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> fec0::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> \
</span></span><span style=display:flex><span> <span style=color:#6c7086;font-style:italic># IPv6-to-4 IPv4-mapped bogons (6-to-4 is all under 2002::/16)</span>
</span></span><span style=display:flex><span> <span style=color:#fab387>2002</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> <span style=color:#fab387>2002</span>:a00::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> <span style=color:#fab387>2002</span>:<span style=color:#fab387>7</span>f00::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> <span style=color:#fab387>2002</span>:a9fe::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>32</span> <span style=color:#fab387>2002</span>:ac10::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>28</span> \
</span></span><span style=display:flex><span> <span style=color:#fab387>2002</span>:c000::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>40</span> <span style=color:#fab387>2002</span>:c000:<span style=color:#fab387>200</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>40</span> <span style=color:#fab387>2002</span>:c0a8::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>32</span> <span style=color:#fab387>2002</span>:c612::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>31</span> \
</span></span><span style=display:flex><span> <span style=color:#fab387>2002</span>:c633:<span style=color:#fab387>6400</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>40</span> <span style=color:#fab387>2002</span>:cb00:<span style=color:#fab387>7100</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>40</span> <span style=color:#fab387>2002</span>:e000::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>20</span> \
</span></span><span style=display:flex><span> <span style=color:#fab387>2002</span>:f000::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>20</span> <span style=color:#fab387>2002</span>:ffff:ffff::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>48</span> \
</span></span><span style=display:flex><span> <span style=color:#6c7086;font-style:italic># Teredo IPv4-mapped bogons (Teredo is all under 2001::/32)</span>
</span></span><span style=display:flex><span> <span style=color:#fab387>2001</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>40</span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:a00::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>40</span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:<span style=color:#fab387>7</span>f00::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>40</span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:a9fe::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>48</span> \
</span></span><span style=display:flex><span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:ac10::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>44</span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:c000::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>56</span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:c000:<span style=color:#fab387>200</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>56</span> \
</span></span><span style=display:flex><span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:c0a8::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>48</span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:c612::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>47</span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:c633:<span style=color:#fab387>6400</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>56</span> \
</span></span><span style=display:flex><span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:cb00:<span style=color:#fab387>7100</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>56</span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:e000::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>36</span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:f000::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>36</span> \
</span></span><span style=display:flex><span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>0</span>:ffff:ffff::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>64</span> \
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># This will cause pf to reply to blocked traffic with a TCP RST packet (for TCP)</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># or ICMP Unreachable (for other protocols) if nothing is specified on a block</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># rule. Some tweaks you may consider depending on your own needs on specific</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># rules:</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># - return-rst: Applies only to TCP packets, send RST</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># - return-icmp/return-icmp6: Reply with ICMP. By default this is ICMP</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   Unreachable but you can specify the ICMP type to use. return-icmp can accept</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   only an ICMPv4 type or both ICMPv4 and ICMPv6 (as `return-icmp (timex)` or</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   `return-icmp (timex, paramprob)`).</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># - drop: Silently discard the packets.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># A return policy is better for quickly tearing down connections on the other</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># side.</span>
</span></span><span style=display:flex><span>set block<span style=color:#89dceb;font-weight:700>-</span>policy <span style=color:#cba6f7>return</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># List interfaces where packet filtering should be skipped. It&#39;s almost never</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># necessary to filter the loopback interface.</span>
</span></span><span style=display:flex><span>set skip on lo
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># &#34;yes&#34; is default, which reassembled fragmented packets before passing them</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># along. Adding &#34;no-df&#34; will also reassemble fragmented packets with the</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># dont-fragment flag set instead of dropping them.</span>
</span></span><span style=display:flex><span>set reassemble yes no<span style=color:#89dceb;font-weight:700>-</span>df
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Enable collecting packet and byte count statistics; view with `pfctl -s info`</span>
</span></span><span style=display:flex><span>set loginterface egress
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># The AT&amp;T BGW320 is... not exactly what you would call a capable piece of</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># hardware. It&#39;s limited to 8192 states, and honestly it would be great if it</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># could actually handle nearly that many states.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Also increase the number of table entries allowed. If you do bad-host</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># filtering, the number of table entries could get quite large, especially if</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># you don&#39;t coalesce IP ranges.</span>
</span></span><span style=display:flex><span>set limit { states <span style=color:#fab387>8192</span>, table<span style=color:#89dceb;font-weight:700>-</span>entries <span style=color:#fab387>5000000</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Enabling syncookies causes pf to appear to accept a TCP connection even if it</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># might be dropped later on. When receiving a SYN, pf will reply with SYN/ACK;</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># when the ACK is received from the client, pf then evaluates the ruleset and</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># takes whatever action the ruleset evaluates to. This can be useful for</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># resiliance against synflood attacks that would exhaust the state table.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Normally I would say this is useful to enable in adaptive mode, but it&#39;s</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># unclear (unlikely) the BGW320 is that smart so there&#39;s not likely to be any</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># benefit to enabling it here. If you want to, what I&#39;ve done other places is to</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># start using syncookies when the state table is 75% full and stop using it only</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># when the state table falls to 20% full.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#set syncookies adaptive (start 75%, end 20%)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Sanitize packets to reduce ambiguity:</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># - no-df: Clear the dont-fragment bit. Helps with NFS implementations that like</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   to generate fragmented packets with dont-fragment set, but needs to be used</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   in combination with random-id because some operating systems also like to</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   generate dont-fragment packets with a zero IP ID field. If an upstream</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   router has to fragment the packet later, that will cause packets to end up</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   being dropped.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># - random-id: Replace the IPv4 ID field with a random identifier iff the packet</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   is not fragmented after optional reassembly. This helps when using no-df,</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   but also helps deal with predictable values generated by some hosts.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># - reassemble tcp: Statefully normalizes TCP connections. See &#34;TRAFFIC</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   NORMALIZATION&#34; in pf.conf(5) for all the details on what pf will do.</span>
</span></span><span style=display:flex><span>match <span style=color:#89dceb;font-weight:700>in</span> all scrub (no<span style=color:#89dceb;font-weight:700>-</span>df random<span style=color:#89dceb;font-weight:700>-</span>id reassemble tcp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># NOTE: If you need to make game consoles work, add static-port to the end of</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># this line.</span>
</span></span><span style=display:flex><span>match out on egress inet from <span style=color:#89dceb;font-weight:700>!</span>(egress:network) to any nat<span style=color:#89dceb;font-weight:700>-</span>to (egress:<span style=color:#fab387>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># We are going to set up default-deny for incoming traffic, but there&#39;s a few</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># things we want to take care of very early in the ruleset.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Port build user does not need network. Though as a gateway/firewall, hopefully</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># you aren&#39;t compiling anything at all here!</span>
</span></span><span style=display:flex><span>block drop out <span style=color:#89dceb>log</span> quick proto {tcp udp} user _pbuild
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Allow traffic to the AT&amp;T gateway device. The BGW320 IP address is in the</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># list of martians but traffic will need to traverse the WAN interface.</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> quick on <span style=color:#89dceb;font-weight:700>$</span>if_lan from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to <span style=color:#fab387>192.168</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>1.254</span> modulate state
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> out quick on egress from any to <span style=color:#fab387>192.168</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>1.254</span> modulate state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Allow DHCPv4, DHCPv6 from WAN, and SLAAC</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># NOTE: fe80::/10 is an IPv6 bogon, but it must be accepted on egress to allow</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># for DHCPv6 and ICMPv6.</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> quick on egress inet proto udp from port bootps to port bootpc
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> out quick on egress inet proto udp from port bootpc to port bootps
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> quick on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet proto udp from port bootpc to port bootps
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> out quick on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet proto udp from port bootps to port bootpc
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> quick on egress inet6 proto udp from fe80::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> port dhcpv6<span style=color:#89dceb;font-weight:700>-</span>server \
</span></span><span style=display:flex><span>  to fe80::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> port dhcpv6<span style=color:#89dceb;font-weight:700>-</span>client no state
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> out quick on egress inet6 proto udp from fe80::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> port dhcpv6<span style=color:#89dceb;font-weight:700>-</span>client \
</span></span><span style=display:flex><span>  to fe80::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> port dhcpv6<span style=color:#89dceb;font-weight:700>-</span>server no state
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># fe80::/10 is link-local and ff02::/16 is multicast, make sure we accept ICMP</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># network management packets on those ranges.</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> quick on egress inet6 proto icmp6 from any \
</span></span><span style=display:flex><span>  to { (egress), ff02::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>16</span>, fe80::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> } \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type { routeradv, neighbradv, neighbrsol }
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> out quick on egress inet6 proto icmp6 from any \
</span></span><span style=display:flex><span>  to { ff02::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>16</span>, fe80::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> } icmp6<span style=color:#89dceb;font-weight:700>-</span>type { routersol, neighbradv, neighbrsol }
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> quick on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from any \
</span></span><span style=display:flex><span>  to { (<span style=color:#89dceb;font-weight:700>$</span>if_lan), ff02::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>16</span>, fe80::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> } \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type { routersol, neighbradv, neighbrsol }
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> quick on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from any \
</span></span><span style=display:flex><span>  to { ff02::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>16</span>, fe80::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> } icmp6<span style=color:#89dceb;font-weight:700>-</span>type { routeradv, neighbradv, neighbrsol }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># The WAN interface has no business sending traffic not covered above to or</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># from addresses not routable on the global public Internet or with no return</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># path.</span>
</span></span><span style=display:flex><span>block drop <span style=color:#89dceb;font-weight:700>in</span> quick on egress from { <span style=color:#89dceb;font-weight:700>&lt;</span>martians<span style=color:#89dceb;font-weight:700>&gt;</span>, no<span style=color:#89dceb;font-weight:700>-</span>route, urpf<span style=color:#89dceb;font-weight:700>-</span>failed } to any
</span></span><span style=display:flex><span>block drop out quick on egress from any to { <span style=color:#89dceb;font-weight:700>&lt;</span>martians<span style=color:#89dceb;font-weight:700>&gt;</span>, no<span style=color:#89dceb;font-weight:700>-</span>route }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Default deny all incoming traffic, default allow all outgoing traffic.</span>
</span></span><span style=display:flex><span>block <span style=color:#cba6f7>return</span> all
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> out modulate state
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Allow LAN outbound to the public Internet</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan from any to <span style=color:#89dceb;font-weight:700>!&lt;</span>martians<span style=color:#89dceb;font-weight:700>&gt;</span> modulate state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># ICMP is critical for IPv6 networks. On IPv4 networks there&#39;s rarely a</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># good reason to restrict it like people do, especially on a home network.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># However, there is also no good reason not to and the relevant standards say</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># ICMP should be restricted without a good reason.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># See icmp(4) and icmp6(4) and RFC4890 for more detail.</span>
</span></span><span style=display:flex><span>block drop <span style=color:#89dceb;font-weight:700>in</span> inet proto icmp
</span></span><span style=display:flex><span>block drop <span style=color:#89dceb;font-weight:700>in</span> inet6 proto icmp6
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># ICMPv4 has no strictly required types, but a few that are good to allow anyway</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># are:</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># - echoreq - Ping is helpful for quick connectivity checks. There are</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   other ways to check if your host is accessible if you block it though, so</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   don&#39;t count on blocking echoreq to keep your hosts hidden.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   echorep is allowed back by the created state from echoreq.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># - unreach with code needfrag - This is used in Path MTU Discovery, if the DF</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   flag is set and unreach with code needfrag comes back your system knows it</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   needs to send smaller packets.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># - timex - Code 0 is returned by routers if the packet TTL has reached zero</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   before reaching the destination. Code 1 is returned by hosts if the packet</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#   couldn&#39;t be fully assembled within its time limit.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># ICMPv4, unlike ICMPv6, is entirely optional so you can simply remove any of</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># these rules you don&#39;t want. You may also need to adjust the maximum packet</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># rates if these limits are too low (expressed in num_packets/num_seconds).</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># LAN gets a much higher rate since it&#39;s reasonable to expect multiple</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># devices might be sending ICMP at the same time.</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet proto icmp from any to (egress:<span style=color:#fab387>0</span>) icmp<span style=color:#89dceb;font-weight:700>-</span>type echoreq \
</span></span><span style=display:flex><span>  <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>100</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>15</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet proto icmp from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to any \
</span></span><span style=display:flex><span>  icmp<span style=color:#89dceb;font-weight:700>-</span>type echoreq <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>100</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>5</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet proto icmp from any to (egress:<span style=color:#fab387>0</span>) icmp<span style=color:#89dceb;font-weight:700>-</span>type unreach \
</span></span><span style=display:flex><span>  code needfrag <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>10</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet proto icmp from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to any \
</span></span><span style=display:flex><span>  icmp<span style=color:#89dceb;font-weight:700>-</span>type unreach code needfrag <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>10</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>5</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet proto icmp from any to (egress:<span style=color:#fab387>0</span>) icmp<span style=color:#89dceb;font-weight:700>-</span>type timex \
</span></span><span style=display:flex><span>  <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>1</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>2</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet proto icmp from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to any \
</span></span><span style=display:flex><span>  icmp<span style=color:#89dceb;font-weight:700>-</span>type timex <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>1</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Unlike ICMPv4, ICMPv6 is critical to a network&#39;s operation. There are</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># different considerations for ICMP destined for the firewall and for ICMP</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># destined for something on the other side of the firewall.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Note: ($if_lan:network) is used here for packets coming in egress because the</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># routable IPv6 addresses for internal hosts are chosen from the delegated</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># prefix assigned to the LAN interface. Technically this does also include the</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># private addresses, but further up the ruleset is a &#39;block quick&#39; rule</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># preventing egress from sending packets to or receiving packets from private</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># address space.</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Transit ICMPv6 - must not be dropped!</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Note: echorep is allowed implicitly by the state opened by an echoreq.</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 from any to (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type { unreach, toobig, echoreq } <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>10</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to \
</span></span><span style=display:flex><span>  <span style=color:#89dceb;font-weight:700>!</span>(<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) icmp6<span style=color:#89dceb;font-weight:700>-</span>type { unreach, toobig, echoreq } <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>10</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 from any to (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type timex code transit <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>5</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to \
</span></span><span style=display:flex><span>  <span style=color:#89dceb;font-weight:700>!</span>(<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) icmp6<span style=color:#89dceb;font-weight:700>-</span>type timex code transit <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>1</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 from any to (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type { paramprob code nxthdr, paramprob code <span style=color:#fab387>2</span> } <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>5</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to \
</span></span><span style=display:flex><span>  <span style=color:#89dceb;font-weight:700>!</span>(<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) icmp6<span style=color:#89dceb;font-weight:700>-</span>type { paramprob code nxthdr, paramprob code <span style=color:#fab387>2</span> } \
</span></span><span style=display:flex><span>	<span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Transit ICMPv6 - normally should not be dropped</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 from any to (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type timex code reassemb <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>5</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to \
</span></span><span style=display:flex><span>  <span style=color:#89dceb;font-weight:700>!</span>(<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) icmp6<span style=color:#89dceb;font-weight:700>-</span>type timex code reassemb <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>1</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 from any to (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type paramprob code badhead <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>5</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to \
</span></span><span style=display:flex><span>  <span style=color:#89dceb;font-weight:700>!</span>(<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) icmp6<span style=color:#89dceb;font-weight:700>-</span>type paramprob code badhead <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>1</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># These handle ICMPv6 messages for mobile IP. If you happen to need this (which</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># is highly unlikely for a personal home network) uncomment these rules</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#pass in on egress inet6 proto icmp6 from any to ($if_lan:network) \</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#  icmp6-type { 144, 145, 146, 147 }</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#pass in on $if_lan inet6 proto icmp6 from ($if_lan:network) to \</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>#  !($if_lan:network) icmp6-type { 144, 145, 146, 147 }</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Local ICMPv6 - must not be dropped</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Note that the desired behaviour may differ between the WAN and LAN interfaces.</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 from any to (egress) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type { echoreq, unreach, toobig, listqry, listenrep, listendone, \
</span></span><span style=display:flex><span>  <span style=color:#fab387>143</span>, <span style=color:#fab387>148</span>, <span style=color:#fab387>149</span>, <span style=color:#fab387>151</span>, <span style=color:#fab387>152</span>, <span style=color:#fab387>153</span> } \
</span></span><span style=display:flex><span>  <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>10</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to (<span style=color:#89dceb;font-weight:700>$</span>if_lan) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type { echoreq, unreach, toobig, listqry, listenrep, listendone, <span style=color:#fab387>143</span> } \
</span></span><span style=display:flex><span>  <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>10</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>1</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 from any to (egress) icmp6<span style=color:#89dceb;font-weight:700>-</span>type timex \
</span></span><span style=display:flex><span>  code transit <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>5</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to (<span style=color:#89dceb;font-weight:700>$</span>if_lan) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type timex <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>1</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 from any to (egress) \
</span></span><span style=display:flex><span>	icmp6<span style=color:#89dceb;font-weight:700>-</span>type { paramprob code nxthdr, paramprob code <span style=color:#fab387>2</span> } <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>5</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to (<span style=color:#89dceb;font-weight:700>$</span>if_lan) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type { paramprob code nxthdr, paramprob code <span style=color:#fab387>2</span> } <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># {router,neighbr}{adv,sol} are not included here because they&#39;ve been handled</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># further up with &#39;pass quick&#39; rules.</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 from any to (egress) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type { <span style=color:#fab387>141</span>, <span style=color:#fab387>142</span> }
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to (<span style=color:#89dceb;font-weight:700>$</span>if_lan) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type { <span style=color:#fab387>141</span>, <span style=color:#fab387>142</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Local ICMPv6 - normally should not be dropped</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 from any to (egress) \
</span></span><span style=display:flex><span>	icmp6<span style=color:#89dceb;font-weight:700>-</span>type timex code reassemb <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>5</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to \
</span></span><span style=display:flex><span>  <span style=color:#89dceb;font-weight:700>!</span>(<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) icmp6<span style=color:#89dceb;font-weight:700>-</span>type timex code reassemb <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>1</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 from any to (egress) \
</span></span><span style=display:flex><span>  icmp6<span style=color:#89dceb;font-weight:700>-</span>type paramprob code badhead <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>5</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan inet6 proto icmp6 from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to \
</span></span><span style=display:flex><span>  <span style=color:#89dceb;font-weight:700>!</span>(<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) icmp6<span style=color:#89dceb;font-weight:700>-</span>type paramprob code badhead <span style=color:#89dceb>max</span><span style=color:#89dceb;font-weight:700>-</span>pkt<span style=color:#89dceb;font-weight:700>-</span>rate <span style=color:#fab387>5</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Allow SSH in from LAN for later configuration and maintenance.</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan proto tcp from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to (<span style=color:#89dceb;font-weight:700>$</span>if_lan) port <span style=color:#fab387>22</span> \
</span></span><span style=display:flex><span>  modulate state
</span></span></code></pre></div><p>Always verify your <a href=https://man.openbsd.org/pf.conf class=external-link target=_blank rel=noopener><code>pf.conf(5)</code></a> changes, then
apply the new rules:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% doas pfctl -nf /etc/pf.conf
</span></span><span style=display:flex><span>% doas pfctl -F rules -f /etc/pf.conf
</span></span></code></pre></div><h3 id=enable-forwarding-packets>Enable forwarding packets
<a class=heading-link href=#enable-forwarding-packets><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Normally, packets can&rsquo;t be forwarded between interfaces. We need to do exactly
that to use the Protectli as a gateway device though. Add these two lines to
<a href=https://man.openbsd.org/sysctl.conf class=external-link target=_blank rel=noopener><code>sysctl.conf(5)</code></a> to enable packet
forwarding:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>net.inet.ip.forwarding=1
</span></span><span style=display:flex><span>net.inet6.ip6.forwarding=1
</span></span></code></pre></div><p>This will take effect after the next reboot. To apply the changes immediately,
run:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% doas sysctl net.inet.ip.forwarding<span style=color:#89dceb;font-weight:700>=</span><span style=color:#fab387>1</span> net.inet6.ip6.forwarding<span style=color:#89dceb;font-weight:700>=</span><span style=color:#fab387>1</span>
</span></span></code></pre></div><h3 id=network-interfaces>Network Interfaces
<a class=heading-link href=#network-interfaces><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Configure your Ethernet interfaces using the
<a href=https://man.openbsd.org/hostname.if class=external-link target=_blank rel=noopener><code>hostname.if(5)</code></a> files. The WAN interface
is <code>em0</code>, the LAN interface is <code>em1</code>. <code>/etc/hostname.em0</code> requires only two easy
lines:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>% cat /etc/hostname.em0
</span></span><span style=display:flex><span>inet autoconf
</span></span><span style=display:flex><span>up
</span></span></code></pre></div><p>You might be tempted to include <code>inet6 autoconf</code> here, but don&rsquo;t. IPv6 will be
configured later, in a way that allows requesting an IPv6 prefix via Prefix
Delegation and advertising that IPv6 prefix on the internal network.</p><p><code>/etc/hostname.em1</code> is similarly easy. This time, although IPv6 will be
configured later, an <code>inet6 autoconf</code> line is required this time so
<a href=https://man.openbsd.org/slaacd class=external-link target=_blank rel=noopener><code>slaacd(8)</code></a> will advertise on the interface.
I also include an alias for the IPv6 Unique Local Addresses prefix I advertise
on my LAN (pick anything within fd00::/8):</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>% cat /etc/hostname.em1
</span></span><span style=display:flex><span>inet 10.0.0.1 255.255.255.0 10.0.0.255
</span></span><span style=display:flex><span>inet6 autoconf
</span></span><span style=display:flex><span>inet6 alias fd01:2345:6789:abcd::1 64
</span></span><span style=display:flex><span>up
</span></span></code></pre></div><p>Change the <code>inet</code> and <code>inet6 alias</code> lines to match your own preferred network
addressing.</p><h3 id=internal-ipv4-addressing-with-dhcpd8>Internal IPv4 addressing with <code>dhcpd(8)</code>
<a class=heading-link href=#internal-ipv4-addressing-with-dhcpd8><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Next, set up <a href=https://man.openbsd.org/dhcpd class=external-link target=_blank rel=noopener><code>dhcpd(8)</code></a> so clients on the LAN
can get IPv4 addresses. A minimal
<a href=https://man.openbsd.org/dhcpd.conf class=external-link target=_blank rel=noopener><code>dhcpd.conf(5)</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% cat /etc/dhcpd.conf
</span></span><span style=display:flex><span>option domain-name-servers 8.8.8.8 8.8.4.4;
</span></span><span style=display:flex><span>default-lease-time 86400;
</span></span><span style=display:flex><span>max-lease-time 86400;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>subnet 10.0.0.0 netmask 255.255.255.0 {
</span></span><span style=display:flex><span>  option routers 10.0.0.1;
</span></span><span style=display:flex><span>  range 10.0.0.100 10.0.0.199;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This will allow up to 100 clients to request an IPv4 address, and leave room for
any static IP address assignment you might need. Enable and start
<a href=https://man.openbsd.org/dhcpd class=external-link target=_blank rel=noopener><code>dhcpd(8)</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% doas rcctl <span style=color:#89dceb>enable</span> dhcpd
</span></span><span style=display:flex><span>% doas rcctl start dhcpd
</span></span></code></pre></div><h3 id=configure-the-bgw320>Configure the BGW320
<a class=heading-link href=#configure-the-bgw320><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>If you&rsquo;ve previously disabled them, you must first enable
<a href=http://192.168.1.254/cgi-bin/dhcpserver.ha class=external-link target=_blank rel=noopener>DHCP</a> and
<a href=http://192.168.1.254/cgi-bin/ip6lan.ha class=external-link target=_blank rel=noopener>DHCPv6</a>
(all options).</p><p>With a minimal <a href=https://man.openbsd.org/pf.conf class=external-link target=_blank rel=noopener><code>pf.conf(5)</code></a> and internal DHCP
working, it&rsquo;s time to connect to the BGW320. From a computer on the BGW320&rsquo;s
network, go to <a href=http://192.168.1.254/cgi-bin/ippass.ha class=external-link target=_blank rel=noopener>http://192.168.1.254/cgi-bin/ippass.ha</a>. You will need the
device passcode, which is printed on the back of the gateway. Make the following
changes, remembering that some changes may reload the page to enable the next
set:</p><ul><li>Change &ldquo;Allocation Mode&rdquo; to &ldquo;Passthrough&rdquo;</li><li>Change &ldquo;Passthrough Mode&rdquo; to &ldquo;DHCPS-fixed&rdquo;</li><li>For &ldquo;Passthrough Fixed MAC Address&rdquo;, enter the MAC address of the WAN
interface you recorded earlier in &ldquo;Manual Entry&rdquo;.</li></ul><p>Click &ldquo;Save&rdquo; to make changes. At this point, you can disconnect all devices from
the BGW320. Plug the Protectli&rsquo;s WAN port in to the BGW320&rsquo;s LAN port 1 and
power it on. Plug your switch into the Protectli&rsquo;s LAN port and your computer
into the switch. Log in to the Protectli via SSH. You should, at this point, see
a public IPv4 address assigned to <code>em0</code> and be able to ping something external
from both the Protectli gateway and your computer. This is why we set up
<a href=https://man.openbsd.org/pf.conf class=external-link target=_blank rel=noopener><code>pf.conf(5)</code></a> so early, you do not want to
have something exposed to the public Internet without proper protection!</p><h3 id=external-ipv6-addresses-with-dhcpcd>External IPv6 addresses with <code>dhcpcd</code>
<a class=heading-link href=#external-ipv6-addresses-with-dhcpcd><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p><code>dhcpcd</code> is what will handle IPv6 on the Internet side. It must first be
installed:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% doas pkg_add dhcpcd
</span></span></code></pre></div><p>Then create <code>/etc/dhcpcd.conf</code>. What has worked for me is:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% cat /etc/dhcpcd.conf
</span></span><span style=display:flex><span>nooption domain_name_servers
</span></span><span style=display:flex><span>nooption domain_name
</span></span><span style=display:flex><span>nooption domain_search
</span></span><span style=display:flex><span>nooption host_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ipv6only
</span></span><span style=display:flex><span>noipv6rs
</span></span><span style=display:flex><span>duid
</span></span><span style=display:flex><span>persistent
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>option rapid_commit
</span></span><span style=display:flex><span>option interface_mtu
</span></span><span style=display:flex><span>require dhcp_server_identifier
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># slaac private
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>script /usr/bin/true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vendorclassid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>allowinterfaces em0 em1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>interface em0
</span></span><span style=display:flex><span> ipv6rs
</span></span><span style=display:flex><span> ia_na 1
</span></span><span style=display:flex><span> ia_pd 2 em1/0
</span></span></code></pre></div><p>Finally, enable and start <code>dhcpcd</code>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% doas rcctl <span style=color:#89dceb>enable</span> dhcpcd
</span></span><span style=display:flex><span>% doas rcctl start dhcpcd
</span></span></code></pre></div><p><a href=https://man.openbsd.org/slaacd class=external-link target=_blank rel=noopener><code>slaacd(8)</code></a> is also needed. AT&amp;T hands out
addresses using DHCPv6, which is handled by <code>dhcpcd</code>, but routing information
comes from Router Advertisements, which requires
<a href=https://man.openbsd.org/slaacd class=external-link target=_blank rel=noopener><code>slaacd(8)</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% doas rcctl <span style=color:#89dceb>enable</span> slaacd
</span></span><span style=display:flex><span>% doas rcctl start slaacd
</span></span></code></pre></div><p>At this point, you should see at least one public IPv6 address on <code>em0</code> and
<code>em1</code> should have both a public IPv6 address plus the address you defined in
<code>hostname.em1</code>. You should be able to verify IPv6 connectivity from the OpenBSD
gateway with <code>ping6 www.google.com</code>.</p><h3 id=internal-ipv6-addresses-with-rad8>Internal IPv6 addresses with <code>rad(8)</code>
<a class=heading-link href=#internal-ipv6-addresses-with-rad8><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Now that you have an IPv6 prefix delegated, you need to advertise that prefix on
your internal network. <a href=https://man.openbsd.org/rad class=external-link target=_blank rel=noopener><code>rad(8)</code></a> allows clients on
your internal network to request IPv6 addresses using SLAAC. A minimal
<a href=https://man.openbsd.org/rad.conf class=external-link target=_blank rel=noopener><code>rad.conf(5)</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% cat /etc/rad.conf
</span></span><span style=display:flex><span>other configuration no
</span></span><span style=display:flex><span>interface em1
</span></span></code></pre></div><p>Enable and start <a href=https://man.openbsd.org/rad class=external-link target=_blank rel=noopener><code>rad(8)</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% doas rcctl <span style=color:#89dceb>enable</span> rad
</span></span><span style=display:flex><span>% doas rcctl start rad
</span></span></code></pre></div><p><a href=https://man.openbsd.org/rad class=external-link target=_blank rel=noopener><code>rad(8)</code></a> will automatically advertise all
prefixes on the interface it&rsquo;s listening on. Since you have a prefix from the
public IPv6 Prefix Delegation as well as a ULA prefix, all clients requesting
IPv6 addresses using SLAAC will get at least two addresses, one from each
prefix. IPv6 clients should pick up their addresses automatically shortly after
starting <a href=https://man.openbsd.org/rad class=external-link target=_blank rel=noopener><code>rad(8)</code></a>.</p><h2 id=trust-but-verify>Trust, but Verify
<a class=heading-link href=#trust-but-verify><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>At this point, you should be able to:</p><ul><li>Run <code>ifconfig em0</code> on your new gateway and see one IPv4 address and at least
two IPv6 addresses.</li><li>Run <code>ifconfig em1</code> on your new gateway and see a different IPv4 address and
at least two different IPv6 addresses.</li><li>Run <code>ping6 www.google.com</code> from both your new gateway and a LAN client and see
responses.</li><li>Check the IP addresses assigned to any internal LAN client and see both an
IPv4 address and at least one IPv6 address in the same range as the address
from the output of <code>ifconfig em1</code>.</li></ul><h2 id=whats-next>What&rsquo;s Next?
<a class=heading-link href=#whats-next><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>At this point you have taken some load off your ISP&rsquo;s Internet gateway device
and put your LAN behind a secure and trustworthy firewall. This is already
a significant improvement in the security and flexibility of your home network,
and is a fine place to stop if you&rsquo;re satisfied already. If so, great! If you
want to try one more thing, my
<a href=https://jgoguen.ca/posts/2024/07/20/openbsd-dns-server-with-unbound-and-statistics/>next post</a> will show how to configure
<a href=https://man.openbsd.org/unbound class=external-link target=_blank rel=noopener><code>unbound(8)</code></a> as a local caching recursive DNS
resolver.</p><h2 id=changelog>Changelog
<a class=heading-link href=#changelog><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>2024-08-02: A helpful reader pointed out that I missed a PF rule to allow
outbound traffic from the LAN to the public Internet. That&rsquo;s been added.</li><li>2024-10-06: Another helpful reader pointed out that I was incorrectly allowing
all ICMP types. <a href=https://www.rfc-editor.org/rfc/rfc4890.txt class=external-link target=_blank rel=noopener>RFC4890</a>
specifies that certain ICMPv6 types SHOULD be blocked, and according to the
definition of SHOULD in RFCs that means it is to be done without a good reason
not to. I do not have a good reason not to. The sample <code>pf.conf</code> has been
updated to only allow ICMP types needed for daily network operation.</li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2013 -
2025
Joel Goguen
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=https://jgoguen.ca/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script src=https://jgoguen.ca/js/scrollbar.min.1eea81363c83b9d090626bcfd7b529574d2f1b23ddd40a5c76aea3dfd8810712.js integrity="sha256-HuqBNjyDudCQYmvP17UpV00vGyPd1Apcdq6j39iBBxI="></script></body></html>