<!doctype html><html lang=en><head><title>OpenBSD IPv6 Home Internet Gateway with Xfinity/Comcast · Heap Overrun
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Joel Goguen"><meta name=description content="Using OpenBSD as a home Internet gateway with Xfinity/Comcast with IPv6
support
"><meta name=keywords content="blog,developer,sysadmin,system administrator,personal,firewall,OpenBSD,Linux"><meta property="og:url" content="https://jgoguen.ca/posts/2022/06/08/openbsd-ipv6-home-internet-gateway-with-xfinity/comcast/"><meta property="og:site_name" content="Heap Overrun"><meta property="og:title" content="OpenBSD IPv6 Home Internet Gateway with Xfinity/Comcast"><meta property="og:description" content="Using OpenBSD as a home Internet gateway with Xfinity/Comcast with IPv6 support"><meta property="og:locale" content="en_ca"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-08T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-07T20:38:20-05:00"><meta property="article:tag" content="OpenBSD"><meta property="article:tag" content="Xfinity"><meta property="article:tag" content="Network"><meta property="article:tag" content="IPv6"><meta property="og:image" content="https://jgoguen.ca/img/logo.jpg"><link rel=canonical href=https://jgoguen.ca/posts/2022/06/08/openbsd-ipv6-home-internet-gateway-with-xfinity/comcast/><link rel=preload href=https://jgoguen.ca/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://jgoguen.ca/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://jgoguen.ca/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://jgoguen.ca/css/coder.min.aa5ef26fa979d6793724ae2dbd71efa94fd16cb1c5c7db3b6651f21f9892a5fd.css integrity="sha256-ql7yb6l51nk3JK4tvXHvqU/RbLHFx9s7ZlHyH5iSpf0=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jgoguen.ca/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://jgoguen.ca/css/style.min.51bc8d573bf8d868a603afccfde7fff4e5ca71d65cbc8ee77d8a514fcc208eba.css integrity="sha256-UbyNVzv42GimA6/M/ef/9OXKcdZcvI7nfYpRT8wgjro=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=https://jgoguen.ca/images/favicon.svg sizes=any><link rel=icon type=image/png href=https://jgoguen.ca/img/favicon_32x32.png sizes=32x32><link rel=icon type=image/png href=https://jgoguen.ca/img/favicon_16x16.png sizes=16x16><link rel=apple-touch-icon href=https://jgoguen.ca/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://jgoguen.ca/images/apple-touch-icon.png><link rel=manifest href=https://jgoguen.ca/site.webmanifest><link rel=mask-icon href=https://jgoguen.ca/images/safari-pinned-tab.svg color=#5bbad5><link rel=me href=https://hachyderm.io/@jgoguen><meta name=robots content="noai, noimageai"><meta name=CCBot content="nofollow"><meta name=tdm-reservation content="1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"OpenBSD IPv6 Home Internet Gateway with Xfinity\/Comcast","headline":"OpenBSD IPv6 Home Internet Gateway with Xfinity\/Comcast","alternativeHeadline":"","description":"Using OpenBSD as a home Internet gateway with Xfinity\/Comcast with IPv6 support","inLanguage":"en-ca","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https://jgoguen.ca/posts/2022/06/08/openbsd-ipv6-home-internet-gateway-with-xfinity/comcast/"},"author":{"@type":"Person","name":"Joel Goguen","url":"https://jgoguen.ca/about"},"copyrightHolder":"Heap Overrun","copyrightYear":"2022","dateCreated":"2022-06-08T00:00:00.00Z","datePublished":"2022-06-08T00:00:00.00Z","dateModified":"2024-12-07T20:38:20.00Z","publisher":{"@type":"Organization","name":"Heap Overrun","url":"https://jgoguen.ca/","logo":{"@type":"ImageObject","url":"https://jgoguen.ca/img/logo.jpg","width":"32","height":"32"}},"image":"https://jgoguen.ca/img/logo.jpg","url":"https://jgoguen.ca/posts/2022/06/08/openbsd-ipv6-home-internet-gateway-with-xfinity/comcast/","wordCount":"1276","genre":["OpenBSD","Xfinity","network","IPv6"],"keywords":[]}</script></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=scroll-to-top class=hidden><i class="fa fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://jgoguen.ca/>Heap Overrun
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/about>About Me</a></li><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/docs/resume.pdf>Résumé</a></li><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/posts>Posts</a></li><li class=navigation-item><a class=navigation-link href=https://jgoguen.ca/contact>Contact Me</a></li></ul></section></nav><div class=content><div id=progress-bar class=hidden aria-hidden=true></div><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://jgoguen.ca/posts/2022/06/08/openbsd-ipv6-home-internet-gateway-with-xfinity/comcast/>OpenBSD IPv6 Home Internet Gateway with Xfinity/Comcast</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-06-08T00:00:00Z>June 8, 2022
</time></span><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-12-07T20:38:20-05:00>Updated: December 7, 2024
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
6-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://jgoguen.ca/tags/openbsd/>OpenBSD</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jgoguen.ca/tags/xfinity/>Xfinity</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jgoguen.ca/tags/network/>Network</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://jgoguen.ca/tags/ipv6/>IPv6</a></span></div></div></header><div><p>When you sign up for Internet service, one thing you&rsquo;re going to get is a home
gateway. It&rsquo;s going to offer wired and wireless Internet connections plus
a bunch of other things you may not want and probably won&rsquo;t need. Unfortunately,
one of the things it&rsquo;s going to offer you is poor performance. The wireless
network on it probably won&rsquo;t cover your whole house, and if you&rsquo;re also limited
in where you can hook it up that could mean poor coverage in the most important
areas. It&rsquo;s also not built on the best hardware for the job, so when it counts
the most you may not get the connection speeds you expect. And, perhaps most
importantly, it&rsquo;s not all that secure.</p><h2 id=before-you-start>Before you start
<a class=heading-link href=#before-you-start><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Before doing anything, decide:</p><ul><li>Are you comfortable installing and configuring a computer that will become
a critical part of your home Internet setup?</li><li>Are you comfortable being technical support if something isn&rsquo;t working
properly?</li><li>Your ISP is unlikely to give you much support, can you troubleshoot enough to
prove a problem isn&rsquo;t on your end?</li></ul><h2 id=hardware>Hardware
<a class=heading-link href=#hardware><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Most ISP home gateways have a way to put them into bridge mode, where a single
device is directly exposed to the Internet. If you don&rsquo;t want to deal with
buying your own modem and getting it registered with Xfinity, this may be
a viable option. However, considering the home gateway is an additional charge
you should get a modem. Removing the home gateway rental fee will pay for the
modem over time. I use the
<a href=https://www.amazon.com/dp/B07DY16W2Z class=external-link target=_blank rel=noopener>Arris SURFboard SB8200 gigabit modem</a>. No
setup is needed on the modem itself, simply call Xfinity customer support and
ask them to register the modem on your account.</p><p>For the gateway/router, I&rsquo;m using a
<a href=https://protectli.com/vault-2-port/ class=external-link target=_blank rel=noopener>2-port Protectli vault</a> with 4GB RAM. It&rsquo;s
a good platform, quiet and fanless, fully supported by OpenBSD out of the box.</p><p>You&rsquo;ll most likely want a switch, and some wireless access points. These can be
anything you want; I&rsquo;m using a UniFi 8-port 150W POE+ switch, and a few UniFi
AC-Pro access points, all of which are old enough to be discontinued. If you
also want to use UniFi equipment, look through
<a href=https://store.ui.com/collections/unifi-network-switching class=external-link target=_blank rel=noopener>https://store.ui.com/collections/unifi-network-switching</a> and
<a href=https://store.ui.com/collections/unifi-network-wireless class=external-link target=_blank rel=noopener>https://store.ui.com/collections/unifi-network-wireless</a> to see what fits your
needs.</p><h2 id=installation>Installation
<a class=heading-link href=#installation><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>To begin, install the latest OpenBSD release. OpenBSD has an
<a href=https://www.openbsd.org/faq/faq4.html class=external-link target=_blank rel=noopener>excellent installation guide</a> you can
follow if needed. The default automatic partition scheme is fine unless you have
some specific needs.</p><p>After installation is complete, reboot and configure
<a href=https://man.openbsd.org/doas class=external-link target=_blank rel=noopener><code>doas(1)</code></a>. Remember that, unlike <code>sudo</code>, all
users who may call <code>doas(1)</code> need to pass a rule in
<a href=https://man.openbsd.org/doas.conf class=external-link target=_blank rel=noopener><code>doas.conf(5)</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># cat /etc/doas.conf
</span></span><span style=display:flex><span>permit persist :wheel
</span></span><span style=display:flex><span>permit nopass root
</span></span></code></pre></div><p>Make sure your user is added to the <code>wheel</code> group, or replace <code>:wheel</code> with your
username.</p><h2 id=configuration>Configuration
<a class=heading-link href=#configuration><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><h3 id=pf4><code>pf(4)</code>
<a class=heading-link href=#pf4><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Before anything else, set up a minimal
<a href=https://man.openbsd.org/pf.conf class=external-link target=_blank rel=noopener><code>pf.conf(5)</code></a>. <code>egress</code> will be the WAN
interface.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#89dceb;font-weight:700>%</span> doas cat <span style=color:#89dceb;font-weight:700>/</span>etc<span style=color:#89dceb;font-weight:700>/</span>pf<span style=color:#89dceb;font-weight:700>.</span>conf
</span></span><span style=display:flex><span>table <span style=color:#89dceb;font-weight:700>&lt;</span>martians<span style=color:#89dceb;font-weight:700>&gt;</span> <span style=color:#cba6f7>const</span> { \
</span></span><span style=display:flex><span>        <span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>8</span> <span style=color:#fab387>10.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>8</span> <span style=color:#fab387>127.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>8</span> <span style=color:#fab387>169.254</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>16</span> <span style=color:#fab387>172.16</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>12</span> <span style=color:#fab387>192.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> \
</span></span><span style=display:flex><span>        <span style=color:#fab387>192.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>2.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> <span style=color:#fab387>192.88</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>99.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> <span style=color:#fab387>192.168</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>16</span> <span style=color:#fab387>198.18</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>15</span> <span style=color:#fab387>198.51</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>100.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> \
</span></span><span style=display:flex><span>        <span style=color:#fab387>203.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>113.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>24</span> <span style=color:#fab387>224.0</span><span style=color:#89dceb;font-weight:700>.</span><span style=color:#fab387>0.0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>3</span> \
</span></span><span style=display:flex><span>        ::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>128</span> ::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>96</span> ::<span style=color:#fab387>1</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>128</span> ::ffff:<span style=color:#fab387>0</span>:<span style=color:#fab387>0</span><span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>96</span> <span style=color:#fab387>100</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>64</span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>10</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>28</span> <span style=color:#fab387>2001</span>:<span style=color:#fab387>2</span>::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>48</span> \
</span></span><span style=display:flex><span>        <span style=color:#fab387>2001</span>:db8::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>32</span> <span style=color:#fab387>3</span>ffe::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>16</span> fec0::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> fc00::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>7</span> \
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set block<span style=color:#89dceb;font-weight:700>-</span>policy <span style=color:#cba6f7>return</span>
</span></span><span style=display:flex><span>set skip on lo
</span></span><span style=display:flex><span>set reassemble yes no<span style=color:#89dceb;font-weight:700>-</span>df
</span></span><span style=display:flex><span>set loginterface egress
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>match <span style=color:#89dceb;font-weight:700>in</span> all scrub (no<span style=color:#89dceb;font-weight:700>-</span>df random<span style=color:#89dceb;font-weight:700>-</span>id reassemble tcp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># NOTE: If you need to make game consoles work, add static-port to the end of</span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># this line</span>
</span></span><span style=display:flex><span>match out on egress inet from <span style=color:#89dceb;font-weight:700>!</span>(egress:network) to any nat<span style=color:#89dceb;font-weight:700>-</span>to (egress:<span style=color:#fab387>0</span>)
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Port build user does not need network</span>
</span></span><span style=display:flex><span>block drop out <span style=color:#89dceb>log</span> quick proto {tcp udp} user _pbuild
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>block drop <span style=color:#89dceb;font-weight:700>in</span> quick on egress from <span style=color:#89dceb;font-weight:700>&lt;</span>martians<span style=color:#89dceb;font-weight:700>&gt;</span> to any
</span></span><span style=display:flex><span>block drop out quick on egress from any to <span style=color:#89dceb;font-weight:700>&lt;</span>martians<span style=color:#89dceb;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic># Default deny all incoming traffic, default allow all outgoing traffic</span>
</span></span><span style=display:flex><span>block <span style=color:#cba6f7>return</span> all
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> out modulate state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> inet proto icmp all icmp<span style=color:#89dceb;font-weight:700>-</span>type echoreq
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> inet6 proto icmp6 all icmp6<span style=color:#89dceb;font-weight:700>-</span>type { echoreq neighbrsol neighbradv }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto icmp6 all icmp6<span style=color:#89dceb;font-weight:700>-</span>type routeradv
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>!</span>egress inet6 proto icmp6 all icmp6<span style=color:#89dceb;font-weight:700>-</span>type routersol
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet proto udp from port bootps to port bootpc
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>!</span>egress inet proto udp from port bootpc to port bootps
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on egress inet6 proto udp from fe80::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> port dhcpv6<span style=color:#89dceb;font-weight:700>-</span>server to fe80::<span style=color:#89dceb;font-weight:700>/</span><span style=color:#fab387>10</span> port dhcpv6<span style=color:#89dceb;font-weight:700>-</span>client no state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>pass</span> <span style=color:#89dceb;font-weight:700>in</span> on <span style=color:#89dceb;font-weight:700>$</span>if_lan proto tcp from (<span style=color:#89dceb;font-weight:700>$</span>if_lan:network) to (<span style=color:#89dceb;font-weight:700>$</span>if_lan) port <span style=color:#fab387>22</span> modulate state
</span></span></code></pre></div><p>Always verify your <code>pf.conf(5)</code> changes, then apply the new rules:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% doas pfctl -nf /etc/pf.conf
</span></span><span style=display:flex><span>% doas pfctl -F rules -f /etc/pf.conf
</span></span></code></pre></div><h3 id=network-interfaces>Network Interfaces
<a class=heading-link href=#network-interfaces><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>First, configure your Ethernet interfaces using the
<a href=http://man.openbsd.org/hostname.if class=external-link target=_blank rel=noopener><code>hostname.if(5)</code></a> files. The WAN interface
is <code>em0</code>, the LAN interface is <code>em1</code>. <code>/etc/hostname.em0</code> requires only two easy
lines:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% cat /etc/hostname.em0
</span></span><span style=display:flex><span>inet autoconf
</span></span><span style=display:flex><span>up
</span></span></code></pre></div><p>You might be tempted to include <code>inet6 autoconf</code> here, but don&rsquo;t. IPv6 will be
configured later, in a way that allows requesting an IPv6 previx via Prefix
Delegation and advertising that IPv6 prefix on the internal network.</p><p><code>/etc/hostname.em1</code> is similarly easy. Again, don&rsquo;t add an <code>inet6</code> line, IPv6
will be handled later.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% cat /etc/hostname.em1
</span></span><span style=display:flex><span>inet 192.168.0.1 255.255.255.0 192.168.0.255
</span></span><span style=display:flex><span>up
</span></span></code></pre></div><p>Change the <code>inet</code> line to match your own preferred network addressing.</p><h3 id=internal-ipv4-addressing-with-dhcpd8>Internal IPv4 addressing with <code>dhcpd(8)</code>
<a class=heading-link href=#internal-ipv4-addressing-with-dhcpd8><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Next, set up <a href=https://man.openbsd.org/dhcpd class=external-link target=_blank rel=noopener><code>dhcpd(8)</code></a> so clients on the LAN
can get IPv4 addresses. A minimal
<a href=https://man.openbsd.org/dhcpd.conf class=external-link target=_blank rel=noopener><code>dhcpd.conf(5)</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% cat /etc/dhcpd.conf
</span></span><span style=display:flex><span>option domain-name-servers 9.9.9.9 8.8.8.8;
</span></span><span style=display:flex><span>default-lease-time 86400;
</span></span><span style=display:flex><span>max-lease-time 86400;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>subnet 192.168.0.0 netmask 255.255.255.0 {
</span></span><span style=display:flex><span>  option routers 192.168.0.1;
</span></span><span style=display:flex><span>  range 192.168.0.100 192.168.0.199;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This will allow up to 100 clients to request an IPv4 address, and leave room for
any static IP address assignment you might need. Enable and start <code>dhcpd</code>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% doas rcctl enable dhcpd
</span></span><span style=display:flex><span>% doas rcctl start dhcpd
</span></span></code></pre></div><h3 id=external-ipv6-addresses-with-dhcpcd>External IPv6 addresses with <code>dhcpcd</code>
<a class=heading-link href=#external-ipv6-addresses-with-dhcpcd><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p><code>dhcpcd</code> is what will handle IPv6 on the Internet side. It must first be
installed:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% doas pkg_add dhcpcd
</span></span></code></pre></div><p>Then create <code>/etc/dhcpcd.conf</code>. What has worked for me is:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% cat /etc/dhcpcd.conf
</span></span><span style=display:flex><span>nooption domain_name_servers
</span></span><span style=display:flex><span>nooption domain_name
</span></span><span style=display:flex><span>nooption domain_search
</span></span><span style=display:flex><span>nooption host_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ipv6only
</span></span><span style=display:flex><span>noipv6rs
</span></span><span style=display:flex><span>duid
</span></span><span style=display:flex><span>persistent
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>option rapid_commit
</span></span><span style=display:flex><span>option interface_mtu
</span></span><span style=display:flex><span>require dhcp_server_identifier
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>script /usr/bin/true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vendorclassid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>allowinterfaces em0 em1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>interface em0
</span></span><span style=display:flex><span>        ipv6rs
</span></span><span style=display:flex><span>        ia_na 1
</span></span><span style=display:flex><span>        ia_pd 1/::/60 em1/1/64
</span></span></code></pre></div><p>Finally, enable and start <code>dhcpcd</code>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% doas rcctl enable dhcpcd
</span></span><span style=display:flex><span>% doas rcctl start dhcpcd
</span></span></code></pre></div><p><a href=https://man.openbsd.org/slaacd class=external-link target=_blank rel=noopener><code>slaacd(8)</code></a> is also needed. Xfinity hands out
addresses using DHCPv6, which is handled by <code>dhcpcd</code>, but routing information
comes from Router Advertisements, which requires <code>slaacd(8)</code>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% doas rcctl enable slaacd
</span></span><span style=display:flex><span>% doas rcctl start slaacd
</span></span></code></pre></div><p>At this point, you should be able to verify IPv6 connectivity from the OpenBSD
gateway with <code>ping6 www.google.com</code>.</p><h3 id=internal-ipv6-addresses-with-rad8>Internal IPv6 addresses with <code>rad(8)</code>
<a class=heading-link href=#internal-ipv6-addresses-with-rad8><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Now that you have an IPv6 prefix delegated, you need to advertise that prefix on
your internal network. <a href=https://man.openbsd.org/rad class=external-link target=_blank rel=noopener><code>rad(8)</code></a> allows clients on
your internal network to request IPv6 addresses using SLAAC. A minimal
<a href=https://man.openbsd.org/rad.conf class=external-link target=_blank rel=noopener><code>rad.conf(5)</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% cat /etc/rad.conf
</span></span><span style=display:flex><span>other configuration no
</span></span><span style=display:flex><span>interface em1
</span></span></code></pre></div><p>Enable and start <code>rad(8)</code>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% doas rcctl enable rad
</span></span><span style=display:flex><span>% doas rcctl start rad
</span></span></code></pre></div><h3 id=enable-forwarding-packets>Enable forwarding packets
<a class=heading-link href=#enable-forwarding-packets><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>The last step is to allow forwarding packets. Add these two lines to
<code>/etc/sysctl.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>net.inet.ip.forwarding=1
</span></span><span style=display:flex><span>net.inet6.ip6.forwarding=1
</span></span></code></pre></div><p>To apply the changes immediately, run:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>% doas sysctl net.inet.ip.forwarding=1 net.inet6.ip6.forwarding=1
</span></span></code></pre></div><h2 id=trust-but-verify>Trust, but Verify
<a class=heading-link href=#trust-but-verify><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>At this point, you should be able to:</p><ul><li>Run <code>ifconfig em0</code> on your new gateway and see one IPv4 address and two IPv6
addresses.</li><li>Run <code>ifconfig em1</code> on your new gateway and see a different IPv4 address and
two different IPv6 addresses.</li><li>Run <code>ping6 www.google.com</code> from both your new gateway and a LAN client and see
responses.</li><li>Check the IP addresses assigned to any internal LAN client and see both an
IPv4 address and at least one IPv6 address in the same range as the address
from the output of <code>ifconfig em1</code>.</li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2013 -
2025
Joel Goguen
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=https://jgoguen.ca/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script src=https://jgoguen.ca/js/scrollbar.min.1eea81363c83b9d090626bcfd7b529574d2f1b23ddd40a5c76aea3dfd8810712.js integrity="sha256-HuqBNjyDudCQYmvP17UpV00vGyPd1Apcdq6j39iBBxI="></script></body></html>